#!/bin/zsh
# Universal Pre-Commit Secret Scanner
# =====================================================================
# BLOCKS commits when staged files contain hardcoded passwords, API keys,
# or other secrets that should live in .env or .copilot-credentials.md.
#
# Install: cp hooks/pre-commit-secrets .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or append to existing pre-commit hook.
# Bypass: git commit --no-verify (requires explicit human override)
#
# This hook is designed to be universal across all projects.
# Patterns are maintained in a single place â€” update here, redeploy everywhere.
# =====================================================================

export PATH="/usr/local/bin:/usr/bin:/bin:/opt/homebrew/bin:$PATH"

# ---------------------------------------------------------------------------
# 1. Secret patterns to scan for in staged content
#    Format: "PATTERN|DESCRIPTION"
#    These are grep -E patterns matched against staged file diffs.
# ---------------------------------------------------------------------------
SECRET_PATTERNS=(
  '<REDACTED_PASSWORD>|VPS SSH password (use .copilot-credentials.md)'
  '<REDACTED_PASSWORD>|VPS sudo password (use .copilot-credentials.md)'
  'whsec_[A-Za-z0-9]{20,}|Stripe webhook secret (use .env)'
  'sk_live_[A-Za-z0-9]{20,}|Stripe live secret key (use .env)'
  'sk_test_[A-Za-z0-9]{20,}|Stripe test secret key (use .env)'
  'AIzaSy[A-Za-z0-9_-]{30,}|Google API key (use .env)'
  'gsk_[A-Za-z0-9]{20,}|Groq API key (use .env)'
  'ghp_[A-Za-z0-9]{36,}|GitHub personal access token (use .env)'
  'glpat-[A-Za-z0-9_-]{20,}|GitLab personal access token (use .env)'
  'xoxb-[0-9]{10,}|Slack bot token (use .env)'
  'xoxp-[0-9]{10,}|Slack user token (use .env)'
  'AKIA[A-Z0-9]{16}|AWS access key ID (use .env)'
  'pk_live_[A-Za-z0-9]{20,}|Stripe publishable live key (use .env)'
  'sq0atp-[A-Za-z0-9_-]{20,}|Square access token (use .env)'
  'SG\.[A-Za-z0-9_-]{22}\.[A-Za-z0-9_-]{43}|SendGrid API key (use .env)'
  'Cr0wlr_Pr0d_[A-Za-z0-9!@#$%^&*_]+|Production DB password (use .copilot-credentials.md)'
  'C0ldEm@il_[A-Za-z0-9!@#$%^&*_]+|COLDemail DB password (use .copilot-credentials.md)'
  'sshpass -p [^*]|Hardcoded sshpass password (use SSHPASS env var)'
)

# ---------------------------------------------------------------------------
# 2. Files to SKIP (credentials files, env files, this hook itself)
# ---------------------------------------------------------------------------
SKIP_PATTERNS='(\.copilot-credentials\.md|\.env$|\.env\.local|\.env\.example|pre-commit-secrets|pre-commit$)'

# ---------------------------------------------------------------------------
# 3. Get staged diff content (only added/modified lines)
# ---------------------------------------------------------------------------
STAGED_DIFF=$(git diff --cached --diff-filter=ACMR -U0 2>/dev/null)

if [[ -z "$STAGED_DIFF" ]]; then
  exit 0
fi

# Get list of staged files (for skip filter)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null)

# Filter out skip-pattern files from diff
FILTERED_DIFF=""
CURRENT_FILE=""
SKIP_FILE=false

while IFS= read -r line; do
  if [[ "$line" =~ ^diff\ --git ]]; then
    CURRENT_FILE=$(echo "$line" | sed 's|.*b/||')
    if echo "$CURRENT_FILE" | grep -qE "$SKIP_PATTERNS"; then
      SKIP_FILE=true
    else
      SKIP_FILE=false
    fi
  fi
  if [[ "$SKIP_FILE" == false ]]; then
    FILTERED_DIFF+="$line"$'\n'
  fi
done <<< "$STAGED_DIFF"

# ---------------------------------------------------------------------------
# 4. Scan for secrets
# ---------------------------------------------------------------------------
VIOLATIONS=0
VIOLATION_DETAILS=""

for entry in "${SECRET_PATTERNS[@]}"; do
  PATTERN="${entry%%|*}"
  DESCRIPTION="${entry##*|}"

  # Search only added lines (starting with +, excluding +++ header)
  MATCHES=$(echo "$FILTERED_DIFF" | grep -E '^\+[^+]' | grep -E "$PATTERN" 2>/dev/null)

  if [[ -n "$MATCHES" ]]; then
    ((VIOLATIONS++))
    VIOLATION_DETAILS+="  ğŸ”‘ $DESCRIPTION\n"
    VIOLATION_DETAILS+="     Pattern: $PATTERN\n"
    # Show first match (redacted)
    FIRST_MATCH=$(echo "$MATCHES" | head -1 | sed 's/^\+//' | head -c 80)
    VIOLATION_DETAILS+="     Match:   ${FIRST_MATCH}...\n\n"
  fi
done

# ---------------------------------------------------------------------------
# 5. Also check: .copilot-credentials.md must NOT be staged
# ---------------------------------------------------------------------------
if echo "$STAGED_FILES" | grep -q '\.copilot-credentials\.md'; then
  ((VIOLATIONS++))
  VIOLATION_DETAILS+="  ğŸš« .copilot-credentials.md is staged for commit!\n"
  VIOLATION_DETAILS+="     Run: git reset HEAD .copilot-credentials.md\n\n"
fi

# ---------------------------------------------------------------------------
# 6. Summary
# ---------------------------------------------------------------------------
if [[ $VIOLATIONS -gt 0 ]]; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  ğŸ”’ SECRET SCANNER: $VIOLATIONS violation(s) found                    â•‘"
  echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
  echo -e "$VIOLATION_DETAILS"
  echo "â•‘  Secrets belong in .env or .copilot-credentials.md       â•‘"
  echo "â•‘  (both must be gitignored)                               â•‘"
  echo "â•‘                                                          â•‘"
  echo "â•‘  âŒ COMMIT BLOCKED â€” remove secrets first                 â•‘"
  echo "â•‘  Override: git commit --no-verify                        â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1
fi

exit 0
