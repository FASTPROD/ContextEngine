#!/bin/zsh
# ContextEngine â€” Pre-commit CE Compliance Check + Secret Scanner
#
# BLOCKS commits when:
#   1. Staged files contain hardcoded passwords/API keys/secrets
#   2. Code files changed but CE docs are stale or missing
#
# Agents ignore warnings â€” only hard blocks prevent compliance drift.
# Bypass: git commit --no-verify (requires explicit human override)
#
# Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# Ensure standard tools are on PATH (git hooks run with minimal PATH)
export PATH="/usr/local/bin:/usr/bin:/bin:/opt/homebrew/bin:$PATH"

# ===================================================================
# PHASE 0: Secret Scanner (runs on ALL commits, not just code commits)
# ===================================================================
SECRET_PATTERNS=(
  '<REDACTED_PASSWORD>|VPS SSH password (use .copilot-credentials.md)'
  '<REDACTED_PASSWORD>|VPS sudo password (use .copilot-credentials.md)'
  'whsec_[A-Za-z0-9]{20,}|Stripe webhook secret (use .env)'
  'sk_live_[A-Za-z0-9]{20,}|Stripe live secret key (use .env)'
  'sk_test_[A-Za-z0-9]{20,}|Stripe test secret key (use .env)'
  'AIzaSy[A-Za-z0-9_-]{30,}|Google API key (use .env)'
  'gsk_[A-Za-z0-9]{20,}|Groq API key (use .env)'
  'ghp_[A-Za-z0-9]{36,}|GitHub personal access token (use .env)'
  'glpat-[A-Za-z0-9_-]{20,}|GitLab personal access token (use .env)'
  'xoxb-[0-9]{10,}|Slack bot token (use .env)'
  'xoxp-[0-9]{10,}|Slack user token (use .env)'
  'AKIA[A-Z0-9]{16}|AWS access key ID (use .env)'
  'pk_live_[A-Za-z0-9]{20,}|Stripe publishable live key (use .env)'
  'SG\.[A-Za-z0-9_-]{22}\.[A-Za-z0-9_-]{43}|SendGrid API key (use .env)'
  'Cr0wlr_Pr0d_[A-Za-z0-9!@#$%^&*_]+|Production DB password (use .copilot-credentials.md)'
  'C0ldEm@il_[A-Za-z0-9!@#$%^&*_]+|COLDemail DB password (use .copilot-credentials.md)'
  'sshpass -p [^*]|Hardcoded sshpass password (use SSHPASS env var)'
)

SKIP_FILES='(\.copilot-credentials\.md|\.env$|\.env\.local|\.env\.example|pre-commit-secrets|pre-commit$)'
STAGED_DIFF=$(git diff --cached --diff-filter=ACMR -U0 2>/dev/null)
STAGED_FILE_LIST=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null)

SECRET_VIOLATIONS=0
SECRET_DETAILS=""

if [[ -n "$STAGED_DIFF" ]]; then
  FILTERED_DIFF=""
  CURRENT_FILE=""
  SKIP_CURRENT=false

  while IFS= read -r line; do
    if [[ "$line" =~ ^diff\ --git ]]; then
      CURRENT_FILE=$(echo "$line" | sed 's|.*b/||')
      if echo "$CURRENT_FILE" | grep -qE "$SKIP_FILES"; then
        SKIP_CURRENT=true
      else
        SKIP_CURRENT=false
      fi
    fi
    if [[ "$SKIP_CURRENT" == false ]]; then
      FILTERED_DIFF+="$line"$'\n'
    fi
  done <<< "$STAGED_DIFF"

  for entry in "${SECRET_PATTERNS[@]}"; do
    PATTERN="${entry%%|*}"
    DESCRIPTION="${entry##*|}"
    MATCHES=$(echo "$FILTERED_DIFF" | grep -E '^\+[^+]' | grep -E "$PATTERN" 2>/dev/null)
    if [[ -n "$MATCHES" ]]; then
      ((SECRET_VIOLATIONS++))
      SECRET_DETAILS+="  ğŸ”‘ $DESCRIPTION\n"
    fi
  done
fi

if echo "$STAGED_FILE_LIST" | grep -q '\.copilot-credentials\.md'; then
  ((SECRET_VIOLATIONS++))
  SECRET_DETAILS+="  ğŸš« .copilot-credentials.md is staged! Run: git reset HEAD .copilot-credentials.md\n"
fi

if [[ $SECRET_VIOLATIONS -gt 0 ]]; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  ğŸ”’ SECRET SCANNER: $SECRET_VIOLATIONS violation(s) found                    â•‘"
  echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
  echo -e "$SECRET_DETAILS"
  echo "â•‘  Secrets belong in .env or .copilot-credentials.md       â•‘"
  echo "â•‘  âŒ COMMIT BLOCKED â€” remove secrets first                 â•‘"
  echo "â•‘  Override: git commit --no-verify                        â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1
fi

# =================================================================== 
# PHASE 1: CE Doc Freshness Check (only for code file commits)
# ===================================================================

# ---------------------------------------------------------------------------
# 2. Check if code files are in the staged diff
# ---------------------------------------------------------------------------
CODE_EXTS="ts|tsx|js|jsx|py|rs|go|java|rb|php|vue|svelte|css|scss|html"
STAGED_CODE=$(git diff --cached --name-only | grep -E "\.($CODE_EXTS)$" | head -1)

# If no code files staged, skip all checks (docs-only commit is fine)
if [[ -z "$STAGED_CODE" ]]; then
  exit 0
fi

# ---------------------------------------------------------------------------
# 3. Check CE doc freshness
# ---------------------------------------------------------------------------
WARNINGS=0
NOW=$(date +%s)
STALE_HOURS=4  # warn if CE doc is older than 4 hours

warn() {
  echo "âš ï¸  CE: $1"
  ((WARNINGS++))
}

check_freshness() {
  local file="$1"
  local label="$2"

  # Find file in common locations
  local found=""
  for candidate_path in "$file" ".github/$file" ".github/instructions/$file"; do
    if [[ -f "$candidate_path" ]]; then
      found="$candidate_path"
      break
    fi
  done

  if [[ -z "$found" ]]; then
    warn "$label â€” NOT FOUND (create it!)"
    return
  fi

  # Check if file is in the staged diff (being updated in this commit)
  if git diff --cached --name-only | grep -q "$found"; then
    return  # Being updated in this commit â€” good!
  fi

  # Check staleness
  local mtime=$(stat -f %m "$found" 2>/dev/null || stat -c %Y "$found" 2>/dev/null)
  if [[ -n "$mtime" ]]; then
    local age_hours=$(( (NOW - mtime) / 3600 ))
    if [[ $age_hours -gt $STALE_HOURS ]]; then
      warn "$label â€” last updated ${age_hours}h ago (not in this commit)"
    fi
  fi
}

check_freshness "copilot-instructions.md" "copilot-instructions.md"
check_freshness "SKILLS.md" "SKILLS.md"
check_freshness "SCORE.md" "SCORE.md"

# ---------------------------------------------------------------------------
# 4. Check if learnings were saved recently (optional â€” check file mtime)
# ---------------------------------------------------------------------------
LEARNINGS_FILE="$HOME/.contextengine/learnings.json"
if [[ -f "$LEARNINGS_FILE" ]]; then
  LEARN_MTIME=$(stat -f %m "$LEARNINGS_FILE" 2>/dev/null || stat -c %Y "$LEARNINGS_FILE" 2>/dev/null)
  if [[ -n "$LEARN_MTIME" ]]; then
    LEARN_AGE=$(( (NOW - LEARN_MTIME) / 3600 ))
    if [[ $LEARN_AGE -gt 8 ]]; then
      warn "No learnings saved in ${LEARN_AGE}h â€” did you forget save_learning?"
    fi
  fi
fi

# ---------------------------------------------------------------------------
# 5. Summary
# ---------------------------------------------------------------------------
if [[ $WARNINGS -gt 0 ]]; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  ContextEngine: $WARNINGS CE compliance violation(s)          â•‘"
  echo "â•‘  Code changed but CE docs are stale or missing.      â•‘"
  echo "â•‘  Update: copilot-instructions, SKILLS, SCORE         â•‘"
  echo "â•‘                                                       â•‘"
  echo "â•‘  âŒ COMMIT BLOCKED â€” update docs first                â•‘"
  echo "â•‘  Override: git commit --no-verify                     â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1  # BLOCK the commit
fi

# All checks passed
exit 0
